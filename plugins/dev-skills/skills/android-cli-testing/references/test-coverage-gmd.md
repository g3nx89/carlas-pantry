# Code Coverage and Gradle Managed Devices Reference

CLI-only execution of JaCoCo code coverage (instrumented, unit, and merged reports) and Gradle Managed Devices (GMD) for hermetic CI emulator management: device definitions, groups, sharding, and GPU configuration.

> For CI-specific GMD patterns (test tiers, device groups), see ci-pipeline-config.md.

## Code Coverage (JaCoCo)

### Instrumented Coverage

Enable in `debug` build type:

```kotlin
android {
  buildTypes {
    debug {
      isTestCoverageEnabled = true
    }
  }
}
```

Generate report:

```bash
./gradlew createDebugCoverageReport
```

Reports written to:
- `app/build/reports/coverage/debug/`

### Merging Unit + Instrumented Coverage

```kotlin
plugins {
  id("jacoco")
}

jacoco {
  toolVersion = "0.8.11"  // Match your Kotlin/AGP compatibility
}

tasks.register<JacocoReport>("jacocoTestReport") {
  dependsOn("testDebugUnitTest", "connectedDebugAndroidTest")

  val fileFilter = listOf(
    "**/R.class", "**/R$*.class",
    "**/BuildConfig.*", "**/Manifest*.*",
    "**/*Test*.*", "android/**/*.*"
  )

  val buildDir = layout.buildDirectory.get().asFile

  val javaDebugTree = fileTree(
    "${buildDir}/intermediates/classes/debug"
  ) { exclude(fileFilter) }

  val kotlinDebugTree = fileTree(
    "${buildDir}/tmp/kotlin-classes/debug"
  ) { exclude(fileFilter) }

  sourceDirectories.from(files("${project.projectDir}/src/main/java"))
  classDirectories.from(files(javaDebugTree, kotlinDebugTree))
  executionData.from(
    fileTree(dir = buildDir, includes = listOf(
      "jacoco/testDebugUnitTest.exec",
      "outputs/code-coverage/connected/*coverage.ec"
    ))
  )

  reports {
    xml.required.set(true)
    html.required.set(true)
  }
}
```

CLI:

```bash
./gradlew testDebugUnitTest connectedDebugAndroidTest jacocoTestReport
```

### Kotlin Coverage Fix

Add `includeNoLocationClasses = true` to filter synthetic classes generated by Kotlin compiler:

```kotlin
tasks.withType<Test> {
  jvmArgs(
    "-noverify",
    "-ea"
  )
  extensions.configure<JacocoTaskExtension> {
    isIncludeNoLocationClasses = true
    excludes = listOf("jdk.internal.*")
  }
}
```

### Manual CLI Merging

Merge coverage files from separate test runs using `jacococli.jar`:

```bash
java -jar jacococli.jar merge \
  app/build/jacoco/testDebugUnitTest.exec \
  app/build/outputs/code-coverage/connected/*coverage.ec \
  --destfile merged-coverage.exec

java -jar jacococli.jar report merged-coverage.exec \
  --classfiles app/build/intermediates/classes/debug \
  --sourcefiles app/src/main/java \
  --html coverage-report/
```

Coverage file locations: `.exec` for unit tests, `.ec` for instrumented tests. Known issues with GMD + coverage in AGP 8.1 (see GMD Limitations below).

## Gradle Managed Devices (GMD)

> **Note:** For CI-specific GMD patterns (test tiers, device groups, ATD image selection), see `ci-pipeline-config.md`.

### Device Definition

```kotlin
android {
  testOptions {
    managedDevices {
      localDevices {
        create("pixel2api30") {
          device = "Pixel 2"
          apiLevel = 30
          systemImageSource = "aosp-atd"  // or "google-atd"
        }
      }
    }
  }
}
```

### CLI

```bash
# Creates emulator, boots, runs tests, shuts down
./gradlew pixel2api30DebugAndroidTest

# With test filtering
./gradlew pixel2api30DebugAndroidTest \
  -Pandroid.testInstrumentationRunnerArguments.class=com.example.smoke.SmokeSuite

# GMD sharding
./gradlew pixel2api30DebugAndroidTest \
  -Pandroid.experimental.androidTest.numManagedDeviceShards=2

# Flaky test retry (re-run failed tests automatically)
./gradlew connectedAndroidTest \
  -Pandroid.testInstrumentationRunnerArguments.numRetries=1
```

### Device Groups (Multi-API Testing)

```kotlin
android {
  testOptions {
    managedDevices {
      localDevices {
        create("pixel2api30") {
          device = "Pixel 2"; apiLevel = 30; systemImageSource = "aosp-atd"
        }
        create("pixel2api33") {
          device = "Pixel 2"; apiLevel = 33; systemImageSource = "google-atd"
        }
      }
      groups {
        create("phoneGroup") {
          targetDevices.add(devices["pixel2api30"])
          targetDevices.add(devices["pixel2api33"])
        }
      }
    }
  }
}
```

Run group task: `./gradlew phoneGroupGroupDebugAndroidTest`

### GPU and CI Properties

```bash
# Headless CI rendering (required for swiftshader on GMD)
./gradlew pixel2api30DebugAndroidTest \
  -Pandroid.testoptions.manageddevices.emulator.gpu=swiftshader_indirect

# Intra-device parallelization (shard tests across N emulator instances)
./gradlew pixel2api30DebugAndroidTest \
  -Pandroid.experimental.androidTest.numManagedDeviceShards=4
```

Or set in `gradle.properties`:

```properties
android.testoptions.manageddevices.emulator.gpu=swiftshader_indirect
```

### Output Paths

- Test results: `build/outputs/androidTest-results/managedDevice/<device>/`
- HTML reports: `build/reports/androidTests/managedDevice/`

### Limitations

- ATD images lack hardware rendering; UI screenshot accuracy may differ from real devices
- Default cap: 16 concurrent emulator instances
- GMD + JaCoCo coverage has known issues in AGP 8.1

GMD integrates with Test Orchestrator via `testOptions.execution = "ANDROIDX_TEST_ORCHESTRATOR"`. Some corner cases with UTP config in early versions.

## Anti-Patterns

| DON'T | DO |
|-------|-----|
| Overuse `testTag` in production code | Prefer content descriptions and semantic labels |
| Run Compose async tests under Robolectric | Move complex `LaunchedEffect` flows to instrumented tests |
| Run screenshot tests without stable locale/font | Pin device configs and locale in Paparazzi/Roborazzi |
| Use Shot for Compose-heavy projects | Use Paparazzi or Roborazzi (no device, faster, more stable) |
| Skip test sharding on large suites | Use `numShards`/`shardIndex` or GMD shards for parallelism |
| Test implementation details (view hierarchy) | Test observable behavior via semantics |
| Call `activity.finish()` before assertions complete | Assert first, then clean up; Compose disposal races cause false failures |
| Over-mock Android types (Bundle, Parcel) in unit tests | Use Robolectric or instrumented tests; mocks hide real serialization bugs |
