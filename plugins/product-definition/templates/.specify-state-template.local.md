---
# Specify Workflow State v3
# This file tracks the progress of the feature-specify skill workflow
# It enables resume after interruption and preserves user decisions
# It also enables re-running clarification/validation on completed workflows
#
# Migration: v2 (phase-based) -> v3 (stage-based)
# See: skills/feature-specify/references/recovery-migration.md
schema_version: 3
feature_id: "{NUMBER}-{SHORT_NAME}"
feature_name: "{FEATURE_NAME}"
user_input: "{ORIGINAL_USER_INPUT}"
created: "{ISO_DATE}"
updated: "{ISO_DATE}"

# Workflow Progress
# Stages: 1 (Setup) | 2 (Spec Draft) | 3 (Checklist) | 4 (Clarification) | 5 (PAL & Design) | 6 (Test Strategy) | 7 (Completion)
current_stage: 1
stage_status: "pending"  # pending | in_progress | completed | failed

# MCP Tool Availability (detected in Stage 1)
mcp_availability:
  pal_available: null       # true | false
  st_available: null        # true | false
  figma_mcp_available: null # true | false

# Stage Completion Tracking
stages:
  setup_figma:  # Stage 1
    status: pending
    timestamp: null
    figma_enabled: null     # true | false
    figma_screens: 0
    figma_context_file: null
    workflow_mode: null     # NEW | RESUME

  spec_draft:  # Stage 2
    status: pending
    timestamp: null
    self_critique_score: null
    user_stories_count: null
    iterations: 0

  mpa_challenge:  # Stage 2 (sub-step)
    status: pending
    timestamp: null
    parallel_mode: null     # true | false
    models_executed: []
    # Structure for each model:
    # - alias: "gpt5.2"
    #   thinking_mode: "high"
    #   focus: "root_cause_analysis"
    #   status: "success"
    #   findings_count: 3
    risk_level: null        # GREEN | YELLOW | RED
    findings_count: 0

  gate_1_problem:  # Stage 2 (sub-step)
    status: pending
    score: null             # 0-4

  gate_2_true_need:  # Stage 2 (sub-step)
    status: pending
    score: null             # 0-4

  checklist_validation:  # Stage 3
    status: pending
    timestamp: null
    platform_type: null     # mobile | generic
    coverage_pct: null
    gaps_count: null
    markers_added: null
    iteration: 0

  clarification:  # Stage 4
    status: pending
    timestamp: null
    questions_answered: 0
    markers_found: 0
    markers_resolved: 0
    iteration: 0

  mpa_edgecases:  # Stage 4 (sub-step)
    status: pending
    timestamp: null
    parallel_mode: null
    models_executed: []
    findings:
      critical: 0
      high: 0
      medium: 0
      low: 0
    injected_clarifications: 0

  mpa_triangulation:  # Stage 4 (sub-step)
    status: pending
    timestamp: null
    original_questions: 0
    deduplicated: 0
    final_questions: 0

  pal_gate:  # Stage 5
    status: pending
    timestamp: null
    iteration: 0
    max_iterations: 2
    pal_score: null
    pal_decision: null      # APPROVED | CONDITIONAL | REJECTED
    dissenting_views: []

  design_feedback:  # Stage 5 (sub-step)
    status: pending
    timestamp: null
    figma_available: null
    outputs: []

  test_strategy:  # Stage 6
    status: pending
    timestamp: null
    skipped: null           # true if feature flag disabled
    test_counts:
      unit: 0
      integration: 0
      e2e: 0
      visual: 0
    ac_coverage_pct: null

  completion:  # Stage 7
    status: pending
    timestamp: null
    completed_at: null

# Iteration Tracking (Stage 3 <-> Stage 4 loop)
iteration_count: 0
iterations: []
  # Structure for each iteration:
  # - iteration: 1
  #   stage_3_coverage: 62
  #   stage_4_questions: 8
  #   timestamp: "2026-01-27T10:30:00Z"

# User Decisions (preserved across interruptions - NEVER re-ask these)
user_decisions:
  figma_enabled: null       # true | false
  platform_choice: null     # mobile | generic
  clarifications: []
  # Structure for each clarification:
  # - question: "What authentication method should be used?"
  #   answer: "OAuth2 with Google Sign-In"
  #   response_type: "selected"  # selected | custom
  #   ba_recommended: "OAuth2 with Google Sign-In (Recommended)"
  #   user_chose_recommended: true
  #   batch: 1
  #   timestamp: "2026-01-27T10:30:00Z"
  #   stage: 4
  #   iteration: 1

# Model Failure Tracking
model_failures: []
  # Structure for each failure:
  # - model: "gpt-5.2"
  #   stage: 2
  #   operation: "thinkdeep"
  #   error: "Connection timeout"
  #   timestamp: "2026-01-27T10:30:00Z"
  #   action_taken: "continue"

# Error Tracking
error_log: []
  # Structure for each error:
  # - timestamp: "2026-01-27T10:35:00Z"
  #   error_type: "NO_RESPONSE"
  #   stage: 4
  #   retry_attempt: 1
  #   recovery_action: "RETRY"

# Checkpoint Log (tracks stage completions for audit)
checkpoint_log: []
  # Structure for each checkpoint:
  # - stage: 2
  #   checkpoint: "SPEC_DRAFT"
  #   status: "completed"
  #   timestamp: "2026-01-27T10:40:00Z"
  #   key_outputs:
  #     - "spec.md written with all sections"
  #     - "Self-critique score: 17/20"

# Resume Guidance
next_step: "Begin specification workflow"
can_resume: true
---

## Workflow Log

<!-- This section is appended automatically as the workflow progresses -->
<!-- Each entry includes timestamp, stage, action, and outcome -->
<!-- Format: ### {ISO_DATE} - Stage {N}: {STAGE_NAME} -->

### Workflow Initialized
- **Timestamp**: {ISO_DATE}
- **Feature**: {FEATURE_NAME}
- **Schema Version**: v3
- **Status**: Ready to begin
