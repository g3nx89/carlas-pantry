---
# Requirements Refinement State File
# Version: 2.0.0
# DO NOT manually edit YAML frontmatter - managed by workflow

# Metadata
schema_version: 2
created: "{ISO_TIMESTAMP}"
updated: "{ISO_TIMESTAMP}"

# Workflow Identity
prd_mode: "NEW"  # NEW | EXTEND
draft_file: "{DRAFT_FILENAME}"
product_name: null  # Extracted from draft heading

# Workflow Progress (v2: stage-based)
current_stage: 1
stage_status: "pending"  # pending | in_progress | completed | failed | waiting_for_user
current_round: 0
waiting_for_user: false
pause_stage: null

# Analysis Mode (user choice - IMMUTABLE once set per round)
analysis_mode: null  # complete | advanced | standard | rapid

# Panel Composition (set in Stage 1)
panel_preset: null  # preset name or "custom" or null (rapid mode)
panel_members_count: 0
panel_config_path: null  # path to .panel-config.local.md

# MCP Availability (detected in Stage 1)
mcp_availability:
  pal_available: null
  st_available: null

# Stage Tracking
stages:
  setup:
    status: pending
    timestamp: null
  research:
    status: pending  # pending | skipped | completed | waiting_for_user
    reports_analyzed: 0
    research_gaps: 0
    timestamp: null
  analysis_questions:
    status: pending
    round: 0
    questions_count: 0
    panel_members: 0  # number of MPA agents dispatched
    thinkdeep_calls: 0
    timestamp: null
  response_analysis:
    status: pending
    round: 0
    completion_rate: 0
    gaps_found: 0
    timestamp: null
  validation_prd:
    status: pending
    validation_mode: null  # pal_consensus | single | internal | skipped
    score: null
    decision: null  # READY | CONDITIONAL | NOT_READY
    prd_mode: null  # NEW | EXTEND
    sections_generated: 0
    sections_extended: 0
    timestamp: null
  completion:
    status: pending
    timestamp: null

# User Decisions (IMMUTABLE once recorded)
user_decisions:
  panel_round_1: null  # preset name, "custom", or "rapid-default"
  panel_round_2: null
  panel_round_3: null
  analysis_mode_round_1: null
  analysis_mode_round_2: null
  analysis_mode_round_3: null
  research_decisions:
    pre_round_1: null  # conduct_research | skip_with_context | skip_entirely
    pre_round_2: null
    pre_round_3: null
    post_completion: null
  research_context: null  # User-provided context if skip_with_context
  extend_mode_choice: null  # expand | regenerate | specific
  validation_mode: null  # pal_consensus | single | skip

# Round Tracking
rounds: []
  # Format for each round:
  # - round_number: 1
  #   questions_file: "working/QUESTIONS-001.md"
  #   analysis_mode: "complete"
  #   generated_at: "{ISO}"
  #   answered_at: null
  #   questions_count: 18
  #   gaps_identified: []

# PRD Section Status (for EXTEND mode)
prd_sections:
  executive_summary: null  # COMPLETE | PARTIAL | PLACEHOLDER | MISSING
  product_definition: null
  target_users: null
  problem_analysis: null
  value_proposition: null
  core_workflows: null
  feature_inventory: null
  screen_inventory: null
  business_constraints: null
  assumptions_risks: null

# Error Log
error_log: []
  # Format:
  # - timestamp: "{ISO}"
  #   stage: "stage_name"
  #   error: "error message"
  #   recovery: "action taken"

# Model Failures
model_failures: []
  # Format:
  # - model: "model_name"
  #   stage: 3
  #   operation: "thinkdeep|consensus"
  #   error: "error message"
  #   timestamp: "{ISO}"
  #   action_taken: "retry|continue|abort"

# Resume Guidance
next_step: null
can_resume: true
---

## Workflow Log

<!-- Append-only log of workflow actions -->

### {TIMESTAMP} - Workflow Initialized
- **PRD Mode:** {NEW|EXTEND}
- **Draft File:** {FILENAME}
- **State File Created**
