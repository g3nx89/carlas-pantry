# Implementation Skill Configuration
# Single source of truth for all configurable values used by the implement skill.
# Referenced by: skills/implement/SKILL.md and skills/implement/references/

# Lock protocol
lock:
  stale_timeout_minutes: 60  # Locks older than this are treated as stale and overridden

# Quality review (Stage 4)
quality_review:
  agent_count: 3  # Number of parallel reviewer agents when code-review skill is unavailable
  focus_areas:
    - "simplicity, DRY principles, and code elegance"
    - "bugs, functional correctness, and edge case handling"
    - "project conventions, abstractions, and pattern adherence"

# Severity classification (canonical definitions)
severity:
  critical:
    description: "Breaks functionality, security vulnerability, data loss risk"
    example: "Unvalidated user input in SQL query"
  high:
    description: "Likely to cause bugs, significant code quality issue"
    example: "Missing error handling on API call"
  medium:
    description: "Code smell, maintainability concern, minor pattern violation"
    example: "Duplicated logic across two files"
  low:
    description: "Style preference, minor optimization opportunity"
    example: "Variable naming inconsistency"
  # Escalation triggers: if a Medium finding matches ANY of these, promote to High.
  # Referenced by: agent-prompts.md (Quality Review Prompt), stage-4-quality-review.md (Section 4.3)
  escalation_triggers:
    - "User-visible data corruption or data loss"
    - "Implicit ordering dependency that silently produces wrong results"
    - "UI state contradiction (displayed state differs from actual state)"
    - "Singleton or shared-state leak across scopes (e.g., state carried between logical sessions)"
    - "Race condition with user-visible effect"
  # Severity ordering (for threshold comparisons): low < medium < high < critical
  # Auto-decision matrix for Stage 4 quality review coordinator.
  # Controls when to escalate to user vs auto-accept findings.
  auto_decision:
    auto_accept_low_only: true          # If ALL findings are Low, auto-accept without user prompt
    medium_auto_accept_max_count: 3     # If highest is Medium AND count <= this, auto-accept with note
    # Critical or High findings ALWAYS escalate to user — never auto-decided

# Handoff artifact tiers (Stage 1 file classification)
# Required files halt if missing. Expected files warn if missing. Optional files are silent.
handoff:
  expected_files:
    - file: "design.md"
      warning: "design.md not found — developer agents will rely on plan.md only for architecture context"
    - file: "test-plan.md"
      warning: "test-plan.md not found — TDD will proceed without a V-Model test strategy document"
  test_cases:
    subdirectories: ["e2e", "integration", "unit", "uat"]
    test_id_patterns: ["E2E-*", "INT-*", "UT-*", "UAT-*"]

# Test coverage thresholds (Stage 3 validation)
# When test-plan.md specifies planned test counts per level, Stage 3 compares actuals against these.
# Referenced by: agent-prompts.md (Completion Validation Prompt), stage-3-validation.md (Section 3.2/3.3)
test_coverage:
  thresholds:
    unit_minimum_pct: 80   # Below this → flag as High severity
    other_minimum_pct: 50  # Below this (integration, e2e) → flag as Medium severity
  # Test quality gate (Stage 3 validation check 11)
  # Patterns indicating placeholder/tautological assertions.
  # Stage 3 scans test files for these; a test file where ALL assertions
  # match tautological patterns is flagged.
  tautological_patterns:
    - "assertTrue\\(true"
    - "assert\\(true\\)"
    - "expect\\(true\\)\\.toBe\\(true\\)"
    - "expect\\(1\\)\\.toBe\\(1\\)"
    - "assertEquals\\(true,\\s*true\\)"
  # If placeholder-only test files >= this count, flag High; 1 file = Medium
  placeholder_file_threshold_high: 2

# Dev-skills integration (conditional skill injection)
# Coordinators read detected_domains from Stage 1 summary and resolve applicable skills.
# The orchestrator never reads or references these values — only coordinators do.
dev_skills:
  enabled: true
  max_skills_per_dispatch: 3  # Cap on DOMAIN skills (always_include is exempt from this cap)
  plugin_path: "dev-skills"   # Sibling plugin name — resolved as $CLAUDE_PLUGIN_ROOT/../dev-skills
  always_include:             # These are ALWAYS injected, exempt from max_skills_per_dispatch
    - skill: "clean-code"
      reason: "Universal code quality patterns (SOLID, naming, guard clauses)"
  domain_mapping:
    kotlin:
      indicators: [".kt", "Kotlin", "KMP", "kotlin"]
      skills: ["kotlin-expert"]
    compose:
      indicators: ["Composable", "Compose", "@Composable", "Material3", "LazyColumn"]
      skills: ["compose-expert"]
    android:
      indicators: ["AndroidManifest", "Activity", "ViewModel", "Intent", "android"]
      skills: ["android-expert"]
    kotlin_async:
      indicators: ["callbackFlow", "supervisorScope", "StateFlow", "SharedFlow", "suspend fun"]
      skills: ["kotlin-coroutines"]
    web_frontend:
      indicators: [".tsx", ".jsx", ".vue", ".svelte", "React", "Next.js", "CSS", "HTML"]
      skills: ["frontend-design"]
    api:
      indicators: ["endpoint", "route", "controller", "REST", "GraphQL", "handler", "/api/"]
      skills: ["api-patterns"]
    database:
      indicators: ["schema", "migration", "model", "entity", "table", "Prisma", "Drizzle", "SQL"]
      skills: ["database-schema-designer"]
    gradle:
      indicators: ["build.gradle", "settings.gradle", "version catalog", "Gradle"]
      skills: ["gradle-expert"]
  # Validation skill injection (Stage 3)
  # Injected into completion validation prompt when test-heavy features are detected
  validation_skills:
    conditional:
      - domains: ["web_frontend", "api", "database"]
        skills: ["qa-test-planner"]
  # Conditional quality review dimensions (Stage 4)
  # Added to the base focus_areas when detected_domains match
  max_conditional_reviewers: 2  # Cap on additional reviewer agents beyond base agent_count
  conditional_review:
    - domains: ["web_frontend", "compose", "android"]
      focus: "accessibility compliance, WCAG 2.1 AA, keyboard navigation, ARIA attributes, touch targets"
      skill: "accessibility-auditor"
    - domains: ["web_frontend"]
      focus: "responsive design, performance metrics, web interface best practices"
      skill: "web-design-guidelines"
  # Documentation skill injection (Stage 5)
  # Always injected for tech-writer when documentation stage runs
  documentation_skills:
    always: ["mermaid-diagrams"]
    conditional:
      - domains: ["api"]
        skills: ["api-patterns"]
      - domains: ["database"]
        skills: ["database-schema-designer"]

# Research MCP integration (conditional library/framework documentation lookup)
# Coordinators read this config and inject research context into agent prompts.
# The orchestrator never calls MCP tools — only Stage 1 (inline) probes availability,
# and coordinators build {research_context} blocks for agents.
research_mcp:
  enabled: true

  # Ref (primary) — exploits session deduplication (Dropout) for ~87% token savings
  ref:
    enabled: true
    max_searches_per_stage: 5
    max_reads_per_stage: 3
    session_accumulation: true   # URLs discovered in Stage 2 are re-read in Stages 4/5 (Ref cache serves faster)
    token_budgets:
      per_source: 2000           # Max tokens per individual source read
      research_context_total: 4000  # Max tokens for the assembled {research_context} block

  # Context7 (secondary) — used for library-specific queries, pre-resolved in Stage 1
  context7:
    enabled: true
    max_queries_per_stage: 3
    pre_resolve_in_stage1: true  # Resolve library IDs upfront so coordinators skip the resolve step
    max_pre_resolve: 5           # Max libraries to pre-resolve in Stage 1

  # Tavily (known-issues-only) — last resort for build errors and known issues
  tavily:
    enabled: true
    search_depth: "basic"
    max_results: 3
    max_searches_per_stage: 2

  # URL extraction from planning artifacts (Stage 1)
  url_extraction:
    enabled: true
    url_patterns:
      - "https?://[^\\s)>\"']+"
    ignore_patterns:
      - "github.com/.*/blob/"
      - "localhost"
      - "127.0.0.1"
      - "example.com"

  # Private documentation discovery via Ref
  private_docs:
    enabled: true
    search_scope: "private"      # Appended to Ref queries as ref_src=private
    max_private_results: 3

  # Graceful degradation — used when MCP tools are unavailable or disabled
  graceful_degradation:
    fallback_text: "No research context available — proceed with codebase knowledge and planning artifacts only."

  # Build error resolution strategy (Stage 2 error handling)
  build_error_resolution:
    enabled: true
    strategy: "ref_first"        # ref_first → escalate to Context7 → Tavily as last resort
    max_retries: 2               # Max MCP lookup attempts per build error
    escalation_after: 1          # Escalate to next tool after this many failed lookups

# Branch format
branch:
  pattern: "feature/<number-padded-to-3-digits>-<kebab-case-title>"
  example: "feature/001-user-auth"

# Auto-commit after stage milestones
# Commits are delegated to a throwaway general-purpose subagent to keep coordinator context clean.
# Failure is always warn-and-continue — a failed commit never blocks execution.
auto_commit:
  enabled: true  # Set to false to disable all auto-commits (opt-out)
  stage2_strategy: per_phase  # per_phase: commit after each phase; batch: single commit after all phases complete
  message_templates:
    phase_complete: "feat({feature_name}): implement {phase_name}"
    phase_batch: "feat({feature_name}): implement all phases"
    review_fix: "fix({feature_name}): address quality review findings"
    documentation: "docs({feature_name}): add feature documentation"
  # Exclude patterns: substring-matched against the git-status-relative file path.
  # Example: ".stage-summaries/" matches "specs/001-feature/.stage-summaries/stage-1-summary.md"
  exclude_patterns:
    - ".implementation-state.local.md"
    - ".stage-summaries/"

# Code simplification (Stage 2 post-phase)
# When enabled, a code-simplifier agent runs after each phase's developer agent completes.
# The simplifier refines modified files for clarity and maintainability while preserving functionality.
# Rollback is safe because simplification runs before auto-commit (git checkout reverts cleanly).
# Referenced by: stage-2-execution.md Step 3.5
code_simplification:
  enabled: true                     # Set to false to skip simplification entirely
  scope: "phase_modified_files"     # Only files modified in the current phase
  exclude_patterns:                 # Substring-matched against file paths — skip these files
    - ".test."
    - ".spec."
    - "__tests__/"
    - "test/"
    - ".md"
    - ".json"
    - ".yaml"
    - ".yml"
  max_files_per_phase: 15           # Skip simplification if more files modified (likely infra/config phase)
  test_verification: true           # Run full test suite after simplification (always recommended)
  rollback_on_test_failure: true    # Revert all simplification changes if any test fails

# UAT mobile testing (Stage 2 per-phase)
# When enabled, runs behavioral acceptance scenarios and Figma visual verification
# against a running app on a Genymotion emulator after each relevant phase.
# Requires: Genymotion emulator running, mobile-mcp MCP server available, Gemini CLI installed.
# Referenced by: stage-1-setup.md Section 1.6e, stage-2-execution.md Step 3.7
uat_execution:
  enabled: true                          # Master switch (also requires clink_dispatch.stage2.uat_mobile_tester.enabled)
  emulator:
    platform: "android"                  # "android" | "ios" (future)
    launch_timeout_ms: 30000             # Wait for device to appear in mobile_list_available_devices
  apk_install:
    reinstall: true                      # Uninstall before install to ensure clean state
    launch_after_install: true           # Launch app after install
    app_package: null                    # Auto-detected from APK; override if needed

# Clink dispatch configuration (PAL MCP integration)
# All clink features are opt-in (enabled: false by default).
# Native agent behavior is the default for every stage.
# Requires: PAL MCP server configured, target CLI installed,
#           config/cli_clients/ directory with role prompt files.
#
# NOTE: All clink agents (Codex, Gemini) share the same MCP servers as native Claude:
#   Ref, Context7, Tavily, Sequential Thinking, Figma (desktop + API), Mobile MCP.
#   MCP tools are available to clink agents automatically — no per-CLI configuration needed.
#   See "MCP Tool Parity" in the Architecture Overview for details.
clink_dispatch:

  # --- GLOBAL SETTINGS ---

  timeout_ms: 300000              # 5 minute default; per-option override available
  timeout_action: "fallback"      # "fallback" (use native/skip) | "error" (halt with user prompt)
  retry:
    max_attempts: 1               # Number of retries on transient failure (0 = no retry)
    backoff_ms: 5000              # Wait between retries

  # MCP tool budgets per clink dispatch (advisory limits on MCP usage by clink agents).
  # Injected into clink agent prompts by coordinators. These are prompt-based guidance,
  # not programmatic hard caps — clink agents receive the budget as text instructions.
  # Coordinators can verify compliance post-dispatch by counting MCP tool references in output.
  # Structure mirrors research_mcp config for naming parity.
  mcp_tool_budgets:
    per_clink_dispatch:
      ref:
        max_searches: 3          # Max ref_search_documentation calls per dispatch
        max_reads: 2             # Max ref_read_url calls per dispatch
      context7:
        max_queries: 2           # Max query-docs calls per dispatch (resolve-library-id is free)
      tavily:
        max_searches: 2          # Max tavily_search / tavily_research calls per dispatch
      sequential_thinking:
        max_chains: 1            # Max sequentialthinking chains per dispatch
      figma:
        max_calls: 5             # UAT mobile tester uses get_design_context + get_screenshot for visual verification
      mobile_mcp:
        max_screenshots: 10      # Max mobile_take_screenshot calls per dispatch
        max_interactions: 50     # Max click/swipe/type calls per dispatch
        max_device_queries: 3    # Max list_devices/list_elements calls per dispatch

  # --- STAGE 2 ---

  stage2:
    # Option A: Delegate per-phase code generation to external coding agent (Tier 3 — deferred)
    phase_developer:
      enabled: false
      cli_name: "codex"
      role: "phase_developer"
      fallback_to_native: true

    # Option B: Pre-implementation API/framework documentation research (Tier 3 — deferred)
    api_researcher:
      enabled: false
      cli_name: "gemini"
      role: "api_researcher"
      max_tokens: 2000
      trigger_keywords: ["API", "SDK", "migration", "v2", "upgrade", "new version"]

    # Option H: Test-first generation from test-case specs (Tier 1)
    test_author:
      enabled: false
      cli_name: "codex"
      role: "test_author"
      requires_test_cases: true     # Static prerequisite: only activate if test-cases/ exists
      allow_developer_adjustments: true  # Developer can fix imports/setup in generated tests

    # Option I: Post-implementation edge case test augmentation (Tier 1)
    test_augmenter:
      enabled: false
      cli_name: "gemini"
      role: "test_augmenter"
      max_additional_tests: 10
      focus: ["boundary", "error", "concurrency", "security"]

    # Option J: Per-phase UAT mobile testing via Genymotion + Figma visual verification (Tier 1)
    # Runs behavioral acceptance scenarios and visual fidelity checks against a running app
    # on a Genymotion emulator after each relevant phase completes in Stage 2.
    # Requires: uat_execution.enabled, Gemini CLI, mobile-mcp MCP server, running emulator.
    uat_mobile_tester:
      enabled: false
      cli_name: "gemini"
      role: "uat_mobile_tester"
      fallback_behavior: "skip"          # skip silently if Gemini unavailable, mobile-mcp unreachable, or no emulator
      # Phase relevance detection — determines which phases trigger UAT
      phase_relevance:
        check_uat_test_ids: true         # Check task descriptions for UAT-* test IDs mapped to test-cases/uat/
        check_ui_file_paths: true        # Check task file paths against UI domain indicators
        ui_domains: ["compose", "android", "web_frontend"]  # Domains from dev_skills.domain_mapping whose indicators suggest UI work
      # Gradle build configuration — builds installable APK before UAT
      gradle_build:
        command: "./gradlew assembleDebug"
        apk_search_pattern: "**/build/outputs/apk/debug/*.apk"
        timeout_ms: 180000               # 3 minutes for Gradle build
      # Figma visual verification — compare running app against Figma designs
      figma:
        enabled: true                    # Enable Figma design comparison alongside behavioral testing
        default_node_url: null           # Optional: static default Figma URL; UAT specs can override per-scenario via figma_url: in YAML frontmatter
        visual_mismatch_threshold: "medium"  # Severity assigned to visual mismatches: "medium" | "high"
      # Finding severity gating — controls phase progression
      severity_gating:
        block_on: ["critical", "high"]   # Halt phase progression for these severities (status: needs-user-input)
        warn_on: ["medium", "low"]       # Log warning, continue for these
      # Screenshot evidence storage
      evidence_dir: ".uat-evidence"      # Relative to FEATURE_DIR; screenshots stored per phase as {evidence_dir}/{phase_name_sanitized}/
      # Timeout for the clink dispatch itself (overrides global clink_dispatch.timeout_ms)
      timeout_ms: 600000                 # 10 minutes — UAT scenarios with mobile-mcp interactions take longer than code review

  # --- STAGE 3 ---

  stage3:
    # Option C: Cross-model specification validation (Tier 2)
    spec_validator:
      enabled: false
      cli_name: "gemini"
      role: "spec_validator"
      merge_strategy: "conservative"  # Use lower test count, flag disagreements

  # --- STAGE 4 ---

  stage4:
    # Option D: Multi-model code review — replaces homogeneous 3-agent review (Tier 1)
    multi_model_review:
      enabled: false
      reviewers:
        - focus: "simplicity, DRY principles, and code elegance"
          cli_name: "gemini"
          role: "simplicity_reviewer"
        - focus: "bugs, functional correctness, and edge case handling"
          cli_name: "codex"
          role: "correctness_reviewer"
        - focus: "project conventions, abstractions, and pattern adherence"
          cli_name: null              # null = native developer agent
          role: null
      # Option E: Conditional security reviewer (Tier 1)
      conditional:
        - focus: "security vulnerabilities, OWASP Top 10"
          cli_name: "codex"
          role: "security_reviewer"
          domains: ["api", "web_frontend", "database"]

    # Option F: Fix review findings with different model (Tier 2)
    fix_engineer:
      enabled: false
      cli_name: "codex"
      role: "fix_engineer"
      fallback_to_native: true

  # --- STAGE 5 ---

  stage5:
    # Option G: Documentation research before tech-writer dispatch (Tier 3 — deferred)
    doc_researcher:
      enabled: false
      cli_name: "gemini"
      role: "doc_researcher"
      max_tokens: 1500

# Timestamp format for stage logs, state checkpoints, and summaries
timestamps:
  format: "ISO_8601"
  precision: "seconds"
  command: "date -u +%Y-%m-%dT%H:%M:%SZ"
